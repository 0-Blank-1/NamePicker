<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random Name Picker</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; background: #f4f4f9; color: #333; text-align: center;}
        h1 { color: #2c3e50; }
        
        .status-box {
            background: white; 
            border: 2px solid #ddd; 
            padding: 30px; 
            margin: 20px auto;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .name-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff; /* Blue for assigned name */
            margin: 10px 0;
        }

        .message {
            font-size: 1.1rem;
            color: #6c757d;
        }
        
        button { 
            padding: 12px 25px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 20px;
            transition: background-color 0.2s;
        }

        .btn-pick { background-color: #28a745; color: white; }
        .btn-pick:hover { background-color: #218838; }
        .btn-pick:disabled { background-color: #ccc; cursor: not-allowed; }

        .btn-unselect { background-color: #dc3545; color: white; margin-top: 10px;}
        .btn-unselect:hover { background-color: #c82333; }

        .loading { font-size: 1.2rem; color: #555; }
    </style>
</head>
<body>

    <h1>Random Name Assignment</h1>
    
    <div class="status-box" id="status-box">
        <div id="loading" class="loading">Connecting to database...</div>
        </div>
    
    <p>Names remaining: <span id="remaining-count">...</span></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, set } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // =========================================================
        // YOUR CONFIGURATION (Kept from your last message)
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBUZujR22d-CoDfBlHkWKHcYCMcQrJeHog",
            authDomain: "name-picker-af4cb.firebaseapp.com",
            databaseURL: "https://name-picker-af4cb-default-rtdb.firebaseio.com",
            projectId: "name-picker-af4cb",
            storageBucket: "name-picker-af4cb.firebasestorage.app",
            messagingSenderId: "756608255624",
            appId: "1:756608255624:web:23252bfb157d5572ea013d",
            measurementId: "G-YHZ5X524MV"
        };
        
        // You can edit this list to change the names displayed
        const NAMES_TO_CREATE = [
            "Aakriti", "Ashruk", "Arushi ", "Allan", "Ayurda", 
            "Awesome", "Bidhan", "Rainaa", "Rejina", "Rythm",
            "Sampanna", "Saurav", "Shirish", "Shreyas", "Suryansha",
            "Suraj"
        ];
        // =========================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const namesRef = ref(db, 'names');

        // Identify the user (Simple browser-based ID)
        let userId = localStorage.getItem("user_uuid");
        if (!userId) {
            userId = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("user_uuid", userId);
        }

        const statusBoxEl = document.getElementById("status-box");
        const loadingEl = document.getElementById("loading");
        const remainingCountEl = document.getElementById("remaining-count");

        // --- REAL-TIME LISTENER (The primary function that runs) ---
        onValue(namesRef, (snapshot) => {
            loadingEl.style.display = "none";
            const data = snapshot.val();

            if (!data) {
                setupInitialData();
                return;
            }
            renderStatus(data);
        });

        // --- SETUP FUNCTION ---
        // Only runs if the database is completely empty
        function setupInitialData() {
            const initialData = {};
            NAMES_TO_CREATE.forEach((name, index) => {
                initialData[`id_${index}`] = { name: name, takenBy: "" };
            });
            set(namesRef, initialData);
        }

        // --- RENDER FUNCTION (The user interface) ---
        function renderStatus(data) {
            statusBoxEl.innerHTML = ""; // Clear existing content
            let mySelection = null;
            let myKey = null;
            let availableNames = [];

            // 1. Check current status
            Object.keys(data).forEach(key => {
                const item = data[key];
                if (item.takenBy === userId) {
                    mySelection = item.name;
                    myKey = key;
                }
                if (item.takenBy === "") {
                    availableNames.push(key);
                }
            });

            // Update remaining count
            remainingCountEl.textContent = availableNames.length;

            if (mySelection) {
                // 2. User has a name
                statusBoxEl.innerHTML = `
                    <div class="message">Your assigned name is:</div>
                    <div class="name-display">${mySelection}</div>
                    <button id="unselect-btn" class="btn-unselect">Unselect Name</button>
                `;
                document.getElementById('unselect-btn').onclick = () => toggleName(myKey, false);

            } else if (availableNames.length > 0) {
                // 3. Names are available, and user needs to pick
                statusBoxEl.innerHTML = `
                    <div class="message">Click below to get a randomly assigned name.</div>
                    <button id="pick-btn" class="btn-pick">Get My Name</button>
                `;
                document.getElementById('pick-btn').onclick = () => getRandomName(availableNames);
                
            } else {
                // 4. No names left
                statusBoxEl.innerHTML = `<div class="message" style="color:#dc3545;">All names have been taken!</div>`;
            }
        }

        // --- NEW RANDOM PICKING LOGIC ---
        function getRandomName(availableKeys) {
            if (availableKeys.length === 0) {
                alert("No names are currently available.");
                return;
            }

            // Pick a random index and get the corresponding key
            const randomIndex = Math.floor(Math.random() * availableKeys.length);
            const randomKey = availableKeys[randomIndex];

            // Attempt to claim the name using a transaction
            toggleName(randomKey, true);
        }


        // --- TRANSACTION LOGIC (Modified to support the new flow) ---
        function toggleName(key, claiming) {
            const itemRef = ref(db, `names/${key}`);
            
            // Disable button during process
            const btn = document.getElementById(claiming ? 'pick-btn' : 'unselect-btn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = claiming ? "Assigning..." : "Releasing...";
            }

            runTransaction(itemRef, (currentData) => {
                if (currentData === null) return currentData; 
                
                if (claiming) {
                    // Try to claim it if it's free
                    if (currentData.takenBy === "") {
                        currentData.takenBy = userId;
                        return currentData;
                    } else {
                        // Failed to claim (someone else got it)
                        return; 
                    }
                } else {
                    // Try to unselect it if it's ours
                    if (currentData.takenBy === userId) {
                        currentData.takenBy = "";
                        return currentData;
                    }
                }
            }).then(result => {
                if (btn) {
                    btn.disabled = false; // Re-enable button on completion
                }
                if (!result.committed && claiming) {
                    alert("Assignment Failed: The system tried to assign you a name, but another user claimed it at the same moment. Please try again.");
                }
            }).catch(console.error);
        }
    </script>
</body>
</html>
