<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Name Picker</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f4f9; color: #333; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        
        .container { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .hidden { display: none !important; }

        h1 { margin-top: 0; color: #2c3e50; }
        
        /* Form Styling */
        input { width: 90%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #0056b3; }
        
        .error-msg { color: red; font-size: 0.9rem; margin-top: 10px; display: none; }

        /* App Styling */
        .assigned-name { font-size: 2.5rem; font-weight: bold; color: #28a745; margin: 20px 0; }
        .locked-msg { color: #dc3545; font-size: 0.8rem; font-style: italic; }
    </style>
</head>
<body>

    <div id="login-container" class="container">
        <h1>Login</h1>
        <form id="myForm">
            <label for="Uname">Username</label>
            <input type="text" name="Uname" id="Uname" required autocomplete="off">

            <label for="pass">Password</label>
            <input type="password" name="pass" id="pass" required>

            <br><br>
            <button type="submit" id="mySubmit">Login</button>
            <div id="error-display" class="error-msg">Error Input >_<!</div>
        </form>
    </div>

    <div id="app-container" class="container hidden">
        <h1 id="welcome-header">Welcome</h1>
        
        <div id="status-area">
            <p>Loading database...</p>
        </div>

        <p>Names remaining: <b id="remaining-count">...</b></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction, set } 
            from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // =========================================================
        // 1. USER CONFIGURATION (EDIT THIS LIST MANUALLY)
        // =========================================================
        // Format is "Username": "Password"
        // Usernames are Case Sensitive! (Saurav is different from saurav)
        const AUTHORIZED_USERS = {
            "Saurav": "admin",
            "Ashruk": "pass123",
            "Arushi": "secret",
            "Guest": "12345"
        };

        // =========================================================
        // 2. FIREBASE CONFIGURATION
        // =========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBUZujR22d-CoDfBlHkWKHcYCMcQrJeHog",
            authDomain: "name-picker-af4cb.firebaseapp.com",
            databaseURL: "https://name-picker-af4cb-default-rtdb.firebaseio.com",
            projectId: "name-picker-af4cb",
            storageBucket: "name-picker-af4cb.firebasestorage.app",
            messagingSenderId: "756608255624",
            appId: "1:756608255624:web:23252bfb157d5572ea013d",
            measurementId: "G-YHZ5X524MV"
        };
        
        // The list of names to be assigned
        const NAMES_TO_CREATE = [
            "Aakriti", "Ashruk", "Arushi ", "Allan", "Ayurda", 
            "Awesome", "Bidhan", "Rainaa", "Rejina", "Rythm",
            "Sampanna", "Saurav", "Shirish", "Shreyas", "Suryansha",
            "Suraj"
        ];

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const namesRef = ref(db, 'names');

        // Global Variables
        let currentUserId = null; 

        // HTML Elements
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('myForm');
        const errorDisplay = document.getElementById('error-display');
        const statusArea = document.getElementById('status-area');
        const remainingEl = document.getElementById('remaining-count');

        // =========================================================
        // 3. LOGIN LOGIC
        // =========================================================
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Stop page reload

            const inputName = document.getElementById('Uname').value.trim();
            const inputPass = document.getElementById('pass').value.trim();

            // CHECK: Does name exist AND does password match?
            if (AUTHORIZED_USERS[inputName] && AUTHORIZED_USERS[inputName] === inputPass) {
                // Success!
                currentUserId = inputName; // Use the actual name as the ID
                loadApp();
            } else {
                // Fail!
                errorDisplay.style.display = "block";
                setTimeout(() => errorDisplay.style.display = "none", 3000);
            }
        });

        function loadApp() {
            // Hide Login, Show App
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            document.getElementById('welcome-header').textContent = `Hi, ${currentUserId}`;

            // Connect to DB
            startDatabaseListener();
        }

        // =========================================================
        // 4. APP LOGIC (Only runs after login)
        // =========================================================
        function startDatabaseListener() {
            onValue(namesRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) {
                    setupInitialData();
                    return;
                }
                renderApp(data);
            });
        }

        function setupInitialData() {
            const initialData = {};
            NAMES_TO_CREATE.forEach((name, index) => {
                initialData[`id_${index}`] = { name: name, takenBy: "" };
            });
            set(namesRef, initialData);
        }

        function renderApp(data) {
            let mySelection = null;
            let availableNames = [];

            Object.keys(data).forEach(key => {
                const item = data[key];
                // Check if THIS user (Saurav, etc) already took this name
                if (item.takenBy === currentUserId) {
                    mySelection = item.name;
                }
                if (item.takenBy === "") {
                    availableNames.push(key);
                }
            });

            remainingEl.textContent = availableNames.length;

            if (mySelection) {
                // Already has a name
                statusArea.innerHTML = `
                    <p>You have been assigned:</p>
                    <div class="assigned-name">${mySelection}</div>
                    <div class="locked-msg">This selection is locked to your account.</div>
                `;
            } else if (availableNames.length > 0) {
                // Needs to pick
                statusArea.innerHTML = `
                    <button id="pick-btn" style="background-color:#28a745;">Get Random Name</button>
                `;
                document.getElementById('pick-btn').onclick = () => pickRandomName(availableNames);
            } else {
                // None left
                statusArea.innerHTML = `<p style="color:red; font-weight:bold;">All names are taken!</p>`;
            }
        }

        function pickRandomName(availableKeys) {
            const btn = document.getElementById('pick-btn');
            btn.disabled = true;
            btn.textContent = "Assigning...";

            const randomIndex = Math.floor(Math.random() * availableKeys.length);
            const randomKey = availableKeys[randomIndex];
            const itemRef = ref(db, `names/${randomKey}`);

            runTransaction(itemRef, (currentData) => {
                if (currentData === null) return currentData;
                if (currentData.takenBy === "") {
                    currentData.takenBy = currentUserId; // Claim with Username
                    return currentData;
                }
            }).then(result => {
                if (!result.committed) {
                    alert("Someone took that name just now. Try again.");
                    btn.disabled = false;
                    btn.textContent = "Get Random Name";
                }
            }).catch(console.error);
        }
    </script>
</body>
</html>
